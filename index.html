<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zombie Survival Game</title>
<style>
  body { margin:0; background:black; overflow:hidden; font-family:Arial, sans-serif; }
  canvas { display:block; margin:0 auto; background:#222; image-rendering:pixelated; }
  #menu, #shopOverlay, #pauseOverlay, #deathOverlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    display:flex; justify-content:center; align-items:center;
    flex-direction:column; background:rgba(0,0,0,0.8); color:white; text-align:center;
    font-family:Arial, sans-serif;
  }
  #menu h1 { font-size:48px; margin-bottom:20px; }
  #menu button, #shopOverlay button, #pauseOverlay button, #deathOverlay button {
    padding:10px 20px; margin:10px; font-size:18px; border:none; border-radius:8px; cursor:pointer;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="menu">
  <h1>Zombie Survival</h1>
  <p>Rules: Survive 20 waves of enemies. Use WASD to move, mouse to aim/shoot, Shift to sprint (uses stamina).<br>
  Visit the shop every 3 waves to upgrade stats or weapons.</p>
  <button onclick="startGame()">Play</button>
</div>
<div id="shopOverlay" style="display:none;"></div>
<div id="pauseOverlay" style="display:none;"> <h2>Game Paused</h2><button onclick="togglePause()">Resume</button></div>
<div id="deathOverlay" style="display:none;"> <h2>You Died!</h2><button onclick="restartGame()">Restart</button></div>
<script>
const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");

// === SPRITES ===
const SPRITES={};
["player_64","zombie","werewolf","robot","grass","tree","rock","crate","pistol","rifle","shotgun"].forEach(n=>{
  SPRITES[n]=new Image();
  SPRITES[n].src=`assets/sprites/${n}.png`;
});
function drawSprite(name,x,y,scale=1){
  const img=SPRITES[name]; if(!img.complete)return;
  let w=32*scale,h=32*scale;
  ctx.drawImage(img,Math.floor(x-w/2),Math.floor(y-h/2),w,h);
}

// === CONFIG & STATE ===
const CONFIG={width:800,height:600};
let player,enemies=[],bullets=[],keys={},money=0,wave=1,paused=false,inShop=false,mapObjects=[];

function resetPlayer(){
  player={x:400,y:300,hp:100,maxHp:100,stamina:100,maxStamina:100,ammo:30,maxAmmo:30,money:0,speed:2};
}

// === MAP GENERATION WITH CLUSTERS ===
function generateMap(){
  mapObjects=[];
  for(let i=0;i<6;i++){let cx=Math.random()*CONFIG.width,cy=Math.random()*CONFIG.height,cluster=3+Math.floor(Math.random()*5);
    for(let j=0;j<cluster;j++){let ox=(Math.random()-.5)*80,oy=(Math.random()-.5)*80;mapObjects.push({type:'tree',x:cx+ox,y:cy+oy});}}
  for(let i=0;i<3;i++){let cx=Math.random()*CONFIG.width,cy=Math.random()*CONFIG.height,cluster=2+Math.floor(Math.random()*4);
    for(let j=0;j<cluster;j++){let ox=(Math.random()-.5)*100,oy=(Math.random()-.5)*100;mapObjects.push({type:'rock',x:cx+ox,y:cy+oy});}}
  for(let r of mapObjects.filter(o=>o.type==='rock')){if(Math.random()<0.3){let ox=(Math.random()-.5)*40,oy=(Math.random()-.5)*40;mapObjects.push({type:'crate',x:r.x+ox,y:r.y+oy});}}
}

// === ENEMIES ===
function spawnWave(){
  enemies=[];let count=wave*2;
  for(let i=0;i<count;i++){
    let type="zombie"; if(wave>=7&&Math.random()<0.3)type="werewolf"; if(wave>=12&&Math.random()<0.2)type="robot";
    enemies.push({x:Math.random()*CONFIG.width,y:Math.random()*CONFIG.height,type,hp:type==="zombie"?30:type==="werewolf"?60:100,damage:type==="zombie"?5:type==="werewolf"?10:15});
  }
}

// === GAME LOOP ===
function update(){if(paused||inShop)return;
  if(keys["Shift"]&&player.stamina>0){player.speed=3;player.stamina-=0.5;}else{player.speed=2;player.stamina=Math.min(player.maxStamina,player.stamina+0.2);} 
  if(keys["w"])player.y-=player.speed; if(keys["s"])player.y+=player.speed; if(keys["a"])player.x-=player.speed; if(keys["d"])player.x+=player.speed;

  for(let e of enemies){
    let dx=player.x-e.x,dy=player.y-e.y,dist=Math.hypot(dx,dy);
    if(dist>0){e.x+=dx/dist*1;e.y+=dy/dist*1;}
    if(dist<20){player.hp-=e.damage*0.02; if(player.hp<=0){document.getElementById("deathOverlay").style.display="flex";}}
  }
}

function render(){ctx.clearRect(0,0,CONFIG.width,CONFIG.height);
  ctx.fillStyle="#0a0";ctx.fillRect(0,0,CONFIG.width,CONFIG.height);
  for(let obj of mapObjects)drawSprite(obj.type,obj.x,obj.y,1);
  drawSprite("player",player.x,player.y,1);
  for(let e of enemies)drawSprite(e.type,e.x,e.y,1);
  renderUI();
}

// === UI ===
function renderUI(){ctx.save();ctx.font="16px Arial";ctx.fillStyle="white";ctx.textAlign="left";
  let sidebarX=CONFIG.width-180,y=40;
  ctx.fillText("Wave: "+wave,sidebarX,y);y+=40;
  ctx.fillText("HP: "+Math.floor(player.hp)+"/"+player.maxHp,sidebarX,y);
  ctx.fillStyle="red";ctx.fillRect(sidebarX,y+10,100,10);
  ctx.fillStyle="lime";ctx.fillRect(sidebarX,y+10,(player.hp/player.maxHp)*100,10);y+=40;
  ctx.fillStyle="white";ctx.fillText("Stamina: "+Math.floor(player.stamina),sidebarX,y);
  ctx.fillStyle="gray";ctx.fillRect(sidebarX,y+10,100,10);
  ctx.fillStyle="yellow";ctx.fillRect(sidebarX,y+10,(player.stamina/player.maxStamina)*100,10);y+=40;
  ctx.fillStyle="white";ctx.fillText("Ammo: "+player.ammo+"/"+player.maxAmmo,sidebarX,y);y+=40;
  ctx.fillText("Money: $"+player.money,sidebarX,y);
  ctx.restore();}

// === SHOP ===
let shopPrices={hp:50,stamina:50,ammo:30,gun:100};
function openShop(){inShop=true;let html="<h2>Shop - Wave "+wave+" complete</h2>";
  html+=`<button onclick=\"buy('hp')\">+20 Max HP ($${shopPrices.hp})</button>`;
  html+=`<button onclick=\"buy('stamina')\">+20 Max Stamina ($${shopPrices.stamina})</button>`;
  html+=`<button onclick=\"buy('ammo')\">+10 Max Ammo + Refill ($${shopPrices.ammo})</button>`;
  html+=`<button onclick=\"buy('gun')\">Better Gun ($${shopPrices.gun})</button>`;
  html+="<button onclick=\"skipShop()\">Skip</button>";
  document.getElementById("shopOverlay").innerHTML=html;
  document.getElementById("shopOverlay").style.display="flex";}
function buy(item){if(player.money>=shopPrices[item]){
  player.money-=shopPrices[item];
  if(item=="hp")player.maxHp+=20;
  if(item=="stamina")player.maxStamina+=20;
  if(item=="ammo"){player.maxAmmo+=10;player.ammo=player.maxAmmo;}
  shopPrices[item]=Math.floor(shopPrices[item]*1.5);
}}
function skipShop(){inShop=false;document.getElementById("shopOverlay").style.display="none";wave++;spawnWave();}

// === INPUT ===
window.addEventListener("keydown",e=>{keys[e.key]=true;if(e.key==="p")togglePause();});
window.addEventListener("keyup",e=>{keys[e.key]=false;});
canvas.addEventListener("click",()=>{if(player.ammo>0){bullets.push({x:player.x,y:player.y,dx:1,dy:0});player.ammo--;}});

function togglePause(){paused=!paused;document.getElementById("pauseOverlay").style.display=paused?"flex":"none";}

// === GAME MANAGEMENT ===
function startGame(){document.getElementById("menu").style.display="none";resetPlayer();wave=1;generateMap();spawnWave();loop();}
function restartGame(){document.getElementById("deathOverlay").style.display="none";resetPlayer();wave=1;generateMap();spawnWave();}

function loop(){update();render();requestAnimationFrame(loop);}
</script>
</body>
</html>
